<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/styles.666a5dc1cd80e47092a71103358e46b56345de6f3044680f856f219cbc2fe91b.css" integrity="sha256-Zmpdwc2A5HCSpxEDNY5GtWNF3m8wRGgPhW8hnLwv6Rs=">

</head>



    
    <meta name="robots" content="noindex">




    <title>Velero Docs - </title>


<body id="docs">
<div class="container-fluid site-outer-container">
    <div class="site-container">
        <header class="site-header">
    <div class="site-header-content">
        <div class="logo">
            <a href="/" aria-label="Velero homepage"><img src="/img/Velero.svg" class="logo" alt="Homepage"/></a>
        </div>
        <ul class="nav-menu" id="header-nav">
            <li class="home"><a href="/" title="Velero">Home</a></li>
            <li class="docs"><a href="/docs/v1.4" title="Documentation">Documentation</a></li>
            <li class="plugins"><a href="/plugins" title="Plugins">Plugins</a></li>
            <li class="blog"><a href="/blog" title="Blog Posts">Blog</a></li>
            <li class="community"><a href="/community" title="Community">Community</a></li>
            <li class="resources"><a href="/resources" title="Resources">Resources</a></li>
        </ul>
        <div class="nav-mobile-link">
            <a href="javascript:void(0);" id="nav-mobile-toggle"></a>
        </div>
    </div>
</header>

        <div class="post-single-hero post-single-hero-short bg-color-med-blue">
            <div class="section">
                <div class="section-content">
                    <h1>Documentation</h1>
                </div>
            </div>
        </div>
        <div class="section section-card pt-4 pb-0">
            <div class="container container-max">
                <div class="row">
                    <div class="col-md-3 toc">
                        <div class="row">
    <div class="dropdown mb-2">
        
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                v1.3.1
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                
                
                

                
                    
                    <a class="dropdown-item"
                       href="/docs/master/restic/">master</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.4/restic/">v1.4</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.3.2/restic/">v1.3.2</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.3.1/restic/">v1.3.1</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.3.0/restic/">v1.3.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.2.0/restic/">v1.2.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.1.0/restic/">v1.1.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v1.0.0/restic/">v1.0.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.11.0/restic/">v0.11.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.10.0/restic/">v0.10.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.9.0/restic/">v0.9.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.8.1/restic/">v0.8.1</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.8.0/restic/">v0.8.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.7.1/restic/">v0.7.1</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.7.0/restic/">v0.7.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.6.0/restic/">v0.6.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.5.0/restic/">v0.5.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.4.0/restic/">v0.4.0</a>
                
                    
                    <a class="dropdown-item"
                       href="/docs/v0.3.0/restic/">v0.3.0</a>
                
            </div>
        
    </div>
</div>
                        <br/>
                        <form class="d-flex align-items-center">
                          <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;">
                            <input type="search" class="form-control docsearch-input" id="search-input" placeholder="Search..."
                                   aria-label="Search for..." autocomplete="off" spellcheck="false" role="combobox"
                                   aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0"
                                   dir="auto" style="position: relative; vertical-align: top;">
                          </span>
                        </form>
                        <nav class="navigation">
    
    
    
        
        
        
        

        
            <h3>Introduction</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/index.html">About Velero</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/how-velero-works">How Velero works</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/locations">About locations</a>
                        
                    </li>
                
            </ul>
        
            <h3>Install</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/basic-install">Basic Install</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/customize-installation">Customize Installation</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/upgrade-to-1.3">Upgrade to 1.3</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/supported-providers">Supported providers</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/contributions/minio">Evaluation install</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/restic">Restic integration</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/examples">Examples</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/uninstalling">Uninstalling</a>
                        
                    </li>
                
            </ul>
        
            <h3>Use</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/disaster-case">Disaster recovery</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/migration-case">Cluster migration</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/backup-reference">Backup reference</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/restore-reference">Restore reference</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/namespace">Run in any namespace</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/hooks">Extend with hooks</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/csi">CSI Support (beta)</a>
                        
                    </li>
                
            </ul>
        
            <h3>Plugins</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/overview-plugins">Overview</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/custom-plugins">Custom plugins</a>
                        
                    </li>
                
            </ul>
        
            <h3>Troubleshoot</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/troubleshooting">Troubleshooting</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/debugging-install">Troubleshoot an install or setup</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/debugging-restores">Troubleshoot a restore</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/restic#troubleshooting">Troubleshoot Restic</a>
                        
                    </li>
                
            </ul>
        
            <h3>Contribute</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/start-contributing">Start Contributing</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/development">Development</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/build-from-source">Build from source</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/run-locally">Run locally</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/code-standards">Code standards</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/website-guidelines">Website guidelines</a>
                        
                    </li>
                
            </ul>
        
            <h3>More information</h3>
            <ul>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/output-file-format">Backup file format</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/api-types">API types</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/faq">FAQ</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/zenhub">ZenHub</a>
                        
                    </li>
                
                    <li>
                        
                            <a href="/docs/v1.3.1/support-process">Support Process</a>
                        
                    </li>
                
            </ul>
        
    
</nav>

                    </div>
                    <div class="col-md-8">
                        
    
    <div class="alert alert-primary" role="alert">
        
            <p>
                <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                Documentation for version v1.3.1 is no longer actively maintained.
                The version you are currently viewing is a static snapshot.
                For up-to-date documentation, see the <a href="/docs/v1.4/restic/">latest version</a>.
            </p>
        
    </div>

                        <div class="documentation-container">
                            <h1 id="restic-integration">Restic Integration</h1>
<p>Velero has support for backing up and restoring Kubernetes volumes using a free open-source backup tool called 

<a href="https://github.com/restic/restic">restic</a>. This support is considered beta quality. Please see the list of 

    

<a href="">limitations</a> to understand if it currently fits your use case.</p>
<p>Velero has always allowed you to take snapshots of persistent volumes as part of your backups if you’re using one of
the supported cloud providers’ block storage offerings (Amazon EBS Volumes, Azure Managed Disks, Google Persistent Disks).
We also provide a plugin model that enables anyone to implement additional object and block storage backends, outside the
main Velero repository.</p>
<p>We integrated restic with Velero so that users have an out-of-the-box solution for backing up and restoring almost any type of Kubernetes
volume*. This is a new capability for Velero, not a replacement for existing functionality. If you&rsquo;re running on AWS, and
taking EBS snapshots as part of your regular Velero backups, there&rsquo;s no need to switch to using restic. However, if you&rsquo;ve
been waiting for a snapshot plugin for your storage platform, or if you&rsquo;re using EFS, AzureFile, NFS, emptyDir,
local, or any other volume type that doesn&rsquo;t have a native snapshot concept, restic might be for you.</p>
<p>Restic is not tied to a specific storage platform, which means that this integration also paves the way for future work to enable
cross-volume-type data migrations. Stay tuned as this evolves!</p>
<p>* hostPath volumes are not supported, but the 

<a href="https://kubernetes.io/docs/concepts/storage/volumes/#local">new local volume type</a> is supported.</p>
<h2 id="setup">Setup</h2>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Velero&rsquo;s restic integration requires the Kubernetes 

<a href="https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation">MountPropagation feature</a>, which is enabled by default in Kubernetes v1.10.0 and later.</li>
</ul>
<h3 id="instructions">Instructions</h3>
<p>Ensure you&rsquo;ve 

<a href="https://github.com/vmware-tanzu/velero/releases/">downloaded latest release</a>.</p>
<p>To install restic, use the <code>--use-restic</code> flag on the <code>velero install</code> command. See the 

    

<a href="/docs/v1.3.1/customize-installation/">install overview</a> for more details. When using restic on a storage provider that doesn&rsquo;t currently have Velero support for snapshots, the <code>--use-volume-snapshots=false</code> flag prevents an unused <code>VolumeSnapshotLocation</code> from being created on installation.</p>
<p>Please note: For some PaaS/CaaS platforms based on Kubernetes such as RancherOS, OpenShift and Enterprise PKS, some modifications are required to the restic DaemonSet spec.</p>
<p><strong>RancherOS</strong></p>
<p>The host path for volumes is not <code>/var/lib/kubelet/pods</code>, rather it is <code>/opt/rke/var/lib/kubelet/pods</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">hostPath</span>:
  <span style="color:#66d9ef">path</span>: /var/lib/kubelet/pods
</code></pre></div><p>to</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">hostPath</span>:
  <span style="color:#66d9ef">path</span>: /opt/rke/var/lib/kubelet/pods
</code></pre></div><p><strong>OpenShift</strong></p>
<p>The restic containers should be running in a <code>privileged</code> mode to be able to mount the correct hostpath to pods volumes.</p>
<ol>
<li>
<p>Add the <code>velero</code> ServiceAccount to the <code>privileged</code> SCC:</p>
<pre><code>$ oc adm policy add-scc-to-user privileged -z velero -n velero
</code></pre></li>
<li>
<p>For OpenShift version  &gt;= <code>4.1</code>, Modify the DaemonSet yaml to request a privileged mode:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#75715e">@@ -67,3 +67,5 @@ spec:
</span><span style="color:#75715e"></span>              value: /credentials/cloud
            - name: VELERO_SCRATCH_DIR
              value: /scratch
<span style="color:#a6e22e">+          securityContext:
</span><span style="color:#a6e22e">+            privileged: true
</span></code></pre></div><p>or</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">oc patch ds/restic <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace velero <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --type json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p <span style="color:#e6db74">&#39;[{&#34;op&#34;:&#34;add&#34;,&#34;path&#34;:&#34;/spec/template/spec/containers/0/securityContext&#34;,&#34;value&#34;: { &#34;privileged&#34;: true}}]&#39;</span>
</code></pre></div></li>
<li>
<p>For OpenShift version  &lt; <code>4.1</code>, Modify the DaemonSet yaml to request a privileged mode and mount the correct hostpath to pods volumes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#75715e">@@ -35,7 +35,7 @@ spec:
</span><span style="color:#75715e"></span>            secretName: cloud-credentials
        - name: host-pods
          hostPath:
<span style="color:#f92672">-            path: /var/lib/kubelet/pods
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+            path: /var/lib/origin/openshift.local.volumes/pods
</span><span style="color:#a6e22e"></span>        - name: scratch
          emptyDir: {}
      containers:
<span style="color:#75715e">@@ -67,3 +67,5 @@ spec:
</span><span style="color:#75715e"></span>              value: /credentials/cloud
            - name: VELERO_SCRATCH_DIR
              value: /scratch
<span style="color:#a6e22e">+          securityContext:
</span><span style="color:#a6e22e">+            privileged: true
</span></code></pre></div><p>or</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">oc patch ds/restic <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace velero <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --type json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p <span style="color:#e6db74">&#39;[{&#34;op&#34;:&#34;add&#34;,&#34;path&#34;:&#34;/spec/template/spec/containers/0/securityContext&#34;,&#34;value&#34;: { &#34;privileged&#34;: true}}]&#39;</span>

oc patch ds/restic <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace velero <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --type json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p <span style="color:#e6db74">&#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/template/spec/volumes/0/hostPath&#34;,&#34;value&#34;: { &#34;path&#34;: &#34;/var/lib/origin/openshift.local.volumes/pods&#34;}}]&#39;</span>
</code></pre></div></li>
</ol>
<p>If restic is not running in a privileged mode, it will not be able to access pods volumes within the mounted hostpath directory because of the default enforced SELinux mode configured in the host system level. You can 

<a href="https://docs.openshift.com/container-platform/3.11/admin_guide/manage_scc.html">create a custom SCC</a> in order to relax the security in your cluster so that restic pods are allowed to use the hostPath volume plug-in without granting them access to the <code>privileged</code> SCC.</p>
<p>By default a userland openshift namespace will not schedule pods on all nodes in the cluster.</p>
<p>To schedule on all nodes the namespace needs an annotation:</p>
<pre><code>oc annotate namespace &lt;velero namespace&gt; openshift.io/node-selector=&quot;&quot;
</code></pre><p>This should be done before velero installation.</p>
<p>Or the ds needs to be deleted and recreated:</p>
<pre><code>oc get ds restic -o yaml -n &lt;velero namespace&gt; &gt; ds.yaml
oc annotate namespace &lt;velero namespace&gt; openshift.io/node-selector=&quot;&quot;
oc create -n &lt;velero namespace&gt; -f ds.yaml
</code></pre><p><strong>Enterprise PKS</strong></p>
<p>You need to enable the <code>Allow Privileged</code> option in your plan configuration so that restic is able to mount the hostpath.</p>
<p>The hostPath should be changed from <code>/var/lib/kubelet/pods</code> to <code>/var/vcap/data/kubelet/pods</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">hostPath</span>:
  <span style="color:#66d9ef">path</span>: /var/vcap/data/kubelet/pods
</code></pre></div><p><strong>Microsoft Azure</strong></p>
<p>If you are using 

<a href="https://docs.microsoft.com/en-us/azure/aks/azure-files-dynamic-pv">Azure Files</a>, you need to add <code>nouser_xattr</code> to your storage class&rsquo;s <code>mountOptions</code>. See 

<a href="https://github.com/restic/restic/issues/1800">this restic issue</a> for more details.</p>
<p>You can use the following command to patch the storage class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl patch storageclass/&lt;YOUR_AZURE_FILE_STORAGE_CLASS_NAME&gt; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --type json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --patch <span style="color:#e6db74">&#39;[{&#34;op&#34;:&#34;add&#34;,&#34;path&#34;:&#34;/mountOptions/-&#34;,&#34;value&#34;:&#34;nouser_xattr&#34;}]&#39;</span>
</code></pre></div><p>You&rsquo;re now ready to use Velero with restic.</p>
<h2 id="back-up">Back up</h2>
<ol>
<li>
<p>Run the following for each pod that contains a volume to back up:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n YOUR_POD_NAMESPACE annotate pod/YOUR_POD_NAME backup.velero.io/backup-volumes<span style="color:#f92672">=</span>YOUR_VOLUME_NAME_1,YOUR_VOLUME_NAME_2,...
</code></pre></div><p>where the volume names are the names of the volumes in the pod spec.</p>
<p>For example, for the following pod:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Pod
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: sample
  <span style="color:#66d9ef">namespace</span>: foo
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">containers</span>:
  - <span style="color:#66d9ef">image</span>: k8s.gcr.io/test-webserver
    <span style="color:#66d9ef">name</span>: test-webserver
    <span style="color:#66d9ef">volumeMounts</span>:
    - <span style="color:#66d9ef">name</span>: pvc-volume
      <span style="color:#66d9ef">mountPath</span>: /volume<span style="color:#ae81ff">-1</span>
    - <span style="color:#66d9ef">name</span>: emptydir-volume
      <span style="color:#66d9ef">mountPath</span>: /volume<span style="color:#ae81ff">-2</span>
  <span style="color:#66d9ef">volumes</span>:
  - <span style="color:#66d9ef">name</span>: pvc-volume
    <span style="color:#66d9ef">persistentVolumeClaim</span>:
      <span style="color:#66d9ef">claimName</span>: test-volume-claim
  - <span style="color:#66d9ef">name</span>: emptydir-volume
    <span style="color:#66d9ef">emptyDir</span>: {}
</code></pre></div><p>You&rsquo;d run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n foo annotate pod/sample backup.velero.io/backup-volumes<span style="color:#f92672">=</span>pvc-volume,emptydir-volume
</code></pre></div><p>This annotation can also be provided in a pod template spec if you use a controller to manage your pods.</p>
</li>
<li>
<p>Take a Velero backup:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">velero backup create NAME OPTIONS...
</code></pre></div></li>
<li>
<p>When the backup completes, view information about the backups:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">velero backup describe YOUR_BACKUP_NAME
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n velero get podvolumebackups -l velero.io/backup-name<span style="color:#f92672">=</span>YOUR_BACKUP_NAME -o yaml
</code></pre></div></li>
</ol>
<h2 id="restore">Restore</h2>
<ol>
<li>
<p>Restore from your Velero backup:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">velero restore create --from-backup BACKUP_NAME OPTIONS...
</code></pre></div></li>
<li>
<p>When the restore completes, view information about your pod volume restores:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">velero restore describe YOUR_RESTORE_NAME
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n velero get podvolumerestores -l velero.io/restore-name<span style="color:#f92672">=</span>YOUR_RESTORE_NAME -o yaml
</code></pre></div></li>
</ol>
<h2 id="limitations">Limitations</h2>
<ul>
<li><code>hostPath</code> volumes are not supported. 

<a href="https://kubernetes.io/docs/concepts/storage/volumes/#local">Local persistent volumes</a> are supported.</li>
<li>Those of you familiar with 

<a href="https://github.com/restic/restic">restic</a> may know that it encrypts all of its data. We&rsquo;ve decided to use a static,
common encryption key for all restic repositories created by Velero. <strong>This means that anyone who has access to your
bucket can decrypt your restic backup data</strong>. Make sure that you limit access to the restic bucket
appropriately. We plan to implement full Velero backup encryption, including securing the restic encryption keys, in
a future release.</li>
<li>An incremental backup chain will be maintained across pod reschedules for PVCs. However, for pod volumes that are <em>not</em>
PVCs, such as <code>emptyDir</code> volumes, when a pod is deleted/recreated (e.g. by a ReplicaSet/Deployment), the next backup of those
volumes will be full rather than incremental, because the pod volume&rsquo;s lifecycle is assumed to be defined by its pod.</li>
<li>Restic scans each file in a single thread. This means that large files (such as ones storing a database) will take a long time to scan for data deduplication, even if the actual
difference is small.</li>
</ul>
<h2 id="customize-restore-helper-container">Customize Restore Helper Container</h2>
<p>Velero uses a helper init container when performing a restic restore. By default, the image for this container is <code>velero/velero-restic-restore-helper:&lt;VERSION&gt;</code>,
where <code>VERSION</code> matches the version/tag of the main Velero image. You can customize the image that is used for this helper by creating a ConfigMap in the Velero namespace with
the alternate image.</p>
<p>In addition, you can customize the resource requirements for the init container, should you need.</p>
<p>The ConfigMap must look like the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: ConfigMap
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#75715e"># any name can be used; Velero uses the labels (below)</span>
  <span style="color:#75715e"># to identify it rather than the name</span>
  <span style="color:#66d9ef">name</span>: restic-restore-action-config
  <span style="color:#75715e"># must be in the velero namespace</span>
  <span style="color:#66d9ef">namespace</span>: velero
  <span style="color:#75715e"># the below labels should be used verbatim in your</span>
  <span style="color:#75715e"># ConfigMap.</span>
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#75715e"># this value-less label identifies the ConfigMap as</span>
    <span style="color:#75715e"># config for a plugin (i.e. the built-in restic restore</span>
    <span style="color:#75715e"># item action plugin)</span>
    <span style="color:#66d9ef">velero.io/plugin-config</span>: <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#75715e"># this label identifies the name and kind of plugin</span>
    <span style="color:#75715e"># that this ConfigMap is for.</span>
    <span style="color:#66d9ef">velero.io/restic</span>: RestoreItemAction
<span style="color:#66d9ef">data</span>:
  <span style="color:#75715e"># The value for &#34;image&#34; can either include a tag or not;</span>
  <span style="color:#75715e"># if the tag is *not* included, the tag from the main Velero</span>
  <span style="color:#75715e"># image will automatically be used.</span>
  <span style="color:#66d9ef">image</span>: myregistry.io/my-custom-helper-image[:OPTIONAL_TAG]

  <span style="color:#75715e"># &#34;cpuRequest&#34; sets the request.cpu value on the restic init containers during restore.</span>
  <span style="color:#75715e"># If not set, it will default to &#34;100m&#34;. A value of &#34;0&#34; is treated as unbounded.</span>
  <span style="color:#66d9ef">cpuRequest</span>: 200m
  
  <span style="color:#75715e"># &#34;memRequest&#34; sets the request.memory value on the restic init containers during restore.</span>
  <span style="color:#75715e"># If not set, it will default to &#34;128Mi&#34;. A value of &#34;0&#34; is treated as unbounded.</span>
  <span style="color:#66d9ef">memRequest</span>: 128Mi

  <span style="color:#75715e"># &#34;cpuLimit&#34; sets the request.cpu value on the restic init containers during restore.</span>
  <span style="color:#75715e"># If not set, it will default to &#34;100m&#34;. A value of &#34;0&#34; is treated as unbounded.</span>
  <span style="color:#66d9ef">cpuLimit</span>: 200m
  
  <span style="color:#75715e"># &#34;memLimit&#34; sets the request.memory value on the restic init containers during restore.</span>
  <span style="color:#75715e"># If not set, it will default to &#34;128Mi&#34;. A value of &#34;0&#34; is treated as unbounded.</span>
  <span style="color:#66d9ef">memLimit</span>: 128Mi


</code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<p>Run the following checks:</p>
<p>Are your Velero server and daemonset pods running?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n velero
</code></pre></div><p>Does your restic repository exist, and is it ready?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">velero restic repo get

velero restic repo get REPO_NAME -o yaml
</code></pre></div><p>Are there any errors in your Velero backup/restore?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">velero backup describe BACKUP_NAME
velero backup logs BACKUP_NAME

velero restore describe RESTORE_NAME
velero restore logs RESTORE_NAME
</code></pre></div><p>What is the status of your pod volume backups/restores?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n velero get podvolumebackups -l velero.io/backup-name<span style="color:#f92672">=</span>BACKUP_NAME -o yaml

kubectl -n velero get podvolumerestores -l velero.io/restore-name<span style="color:#f92672">=</span>RESTORE_NAME -o yaml
</code></pre></div><p>Is there any useful information in the Velero server or daemon pod logs?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n velero logs deploy/velero
kubectl -n velero logs DAEMON_POD_NAME
</code></pre></div><p><strong>NOTE</strong>: You can increase the verbosity of the pod logs by adding <code>--log-level=debug</code> as an argument
to the container command in the deployment/daemonset pod template spec.</p>
<h2 id="how-backup-and-restore-work-with-restic">How backup and restore work with restic</h2>
<p>We introduced three custom resource definitions and associated controllers:</p>
<ul>
<li>
<p><code>ResticRepository</code> - represents/manages the lifecycle of Velero&rsquo;s 

<a href="http://restic.readthedocs.io/en/latest/100_references.html#terminology">restic repositories</a>. Velero creates
a restic repository per namespace when the first restic backup for a namespace is requested. The controller
for this custom resource executes restic repository lifecycle commands &ndash; <code>restic init</code>, <code>restic check</code>,
and <code>restic prune</code>.</p>
<p>You can see information about your Velero restic repositories by running <code>velero restic repo get</code>.</p>
</li>
<li>
<p><code>PodVolumeBackup</code> - represents a restic backup of a volume in a pod. The main Velero backup process creates
one or more of these when it finds an annotated pod. Each node in the cluster runs a controller for this
resource (in a daemonset) that handles the <code>PodVolumeBackups</code> for pods on that node. The controller executes
<code>restic backup</code> commands to backup pod volume data.</p>
</li>
<li>
<p><code>PodVolumeRestore</code> - represents a restic restore of a pod volume. The main Velero restore process creates one
or more of these when it encounters a pod that has associated restic backups. Each node in the cluster runs a
controller for this resource (in the same daemonset as above) that handles the <code>PodVolumeRestores</code> for pods
on that node. The controller executes <code>restic restore</code> commands to restore pod volume data.</p>
</li>
</ul>
<h3 id="backup">Backup</h3>
<ol>
<li>The main Velero backup process checks each pod that it&rsquo;s backing up for the annotation specifying a restic backup
should be taken (<code>backup.velero.io/backup-volumes</code>)</li>
<li>When found, Velero first ensures a restic repository exists for the pod&rsquo;s namespace, by:
<ul>
<li>checking if a <code>ResticRepository</code> custom resource already exists</li>
<li>if not, creating a new one, and waiting for the <code>ResticRepository</code> controller to init/check it</li>
</ul>
</li>
<li>Velero then creates a <code>PodVolumeBackup</code> custom resource per volume listed in the pod annotation</li>
<li>The main Velero process now waits for the <code>PodVolumeBackup</code> resources to complete or fail</li>
<li>Meanwhile, each <code>PodVolumeBackup</code> is handled by the controller on the appropriate node, which:
<ul>
<li>has a hostPath volume mount of <code>/var/lib/kubelet/pods</code> to access the pod volume data</li>
<li>finds the pod volume&rsquo;s subdirectory within the above volume</li>
<li>runs <code>restic backup</code></li>
<li>updates the status of the custom resource to <code>Completed</code> or <code>Failed</code></li>
</ul>
</li>
<li>As each <code>PodVolumeBackup</code> finishes, the main Velero process adds it to the Velero backup in a file named <code>&lt;backup-name&gt;-podvolumebackups.json.gz</code>. This file gets uploaded to object storage alongside the backup tarball. It will be used for restores, as seen in the next section.</li>
</ol>
<h3 id="restore-1">Restore</h3>
<ol>
<li>The main Velero restore process checks each existing <code>PodVolumeBackup</code> custom resource in the cluster to backup from.</li>
<li>For each <code>PodVolumeBackup</code> found, Velero first ensures a restic repository exists for the pod&rsquo;s namespace, by:
<ul>
<li>checking if a <code>ResticRepository</code> custom resource already exists</li>
<li>if not, creating a new one, and waiting for the <code>ResticRepository</code> controller to init/check it (note that
in this case, the actual repository should already exist in object storage, so the Velero controller will simply
check it for integrity)</li>
</ul>
</li>
<li>Velero adds an init container to the pod, whose job is to wait for all restic restores for the pod to complete (more
on this shortly)</li>
<li>Velero creates the pod, with the added init container, by submitting it to the Kubernetes API</li>
<li>Velero creates a <code>PodVolumeRestore</code> custom resource for each volume to be restored in the pod</li>
<li>The main Velero process now waits for each <code>PodVolumeRestore</code> resource to complete or fail</li>
<li>Meanwhile, each <code>PodVolumeRestore</code> is handled by the controller on the appropriate node, which:
<ul>
<li>has a hostPath volume mount of <code>/var/lib/kubelet/pods</code> to access the pod volume data</li>
<li>waits for the pod to be running the init container</li>
<li>finds the pod volume&rsquo;s subdirectory within the above volume</li>
<li>runs <code>restic restore</code></li>
<li>on success, writes a file into the pod volume, in a <code>.velero</code> subdirectory, whose name is the UID of the Velero restore
that this pod volume restore is for</li>
<li>updates the status of the custom resource to <code>Completed</code> or <code>Failed</code></li>
</ul>
</li>
<li>The init container that was added to the pod is running a process that waits until it finds a file
within each restored volume, under <code>.velero</code>, whose name is the UID of the Velero restore being run</li>
<li>Once all such files are found, the init container&rsquo;s process terminates successfully and the pod moves
on to running other init containers/the main containers.</li>
</ol>
<h2 id="3rd-party-controllers">3rd party controllers</h2>
<h3 id="monitor-backup-annotation">Monitor backup annotation</h3>
<p>Velero does not currently provide a mechanism to detect persistent volume claims that are missing the restic backup annotation.</p>
<p>To solve this, a controller was written by Thomann Bits&amp;Beats: 

<a href="https://github.com/bitsbeats/velero-pvc-watcher">velero-pvc-watcher</a></p>
<h3 id="add-backup-annotation">Add backup annotation</h3>
<p>Velero does not currently provide a single command or automatic way to backup all volume resources in the cluster without annotating pods or pod templates.</p>
<p>The 

<a href="https://github.com/duyanghao/velero-volume-controller">velero-volume-controller</a> written by duyanghao helps to solve this problem by adding backup annotation to pods with volumes automatically.</p>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="section section-background-darkest-blue">
    <div class="section-content">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-lg-8">
                <h5>Getting Started</h5>
                <p>To help you get started, see the documentation.</p>
            </div>
            <div class="col-xs-12 col-sm-6 col-lg-3 offset-lg-1">
                <p><strong></strong></p>
                <a href="/docs"
                   class="btn btn-sm btn-primary btn-no-border">Documentation</a>
            </div>
        </div>
    </div>
</div>

<footer class="section site-footer">
    <div class="section-content">
        <div class="row justify-content-between align-items-center">
            <div class="col-12 col-md-8 mb-3 mb-md-0">
                <ul class="social-links text-center text-md-left">
                    
                        <li>
                            
                                <i class="fab fa-twitter fa-lg fa-fw mr-1"></i>
                            
                            <a href="https://twitter.com/projectvelero">Twitter</a>
                        </li>
                    
                        <li>
                            
                                <i class="fab fa-slack fa-lg fa-fw mr-1"></i>
                            
                            <a href="https://kubernetes.slack.com/messages/velero">Slack</a>
                        </li>
                    
                        <li>
                            
                                <i class="fas fa-users fa-lg fa-fw mr-1"></i>
                            
                            <a href="https://groups.google.com/forum/#!forum/projectvelero">Google Groups</a>
                        </li>
                    
                        <li>
                            
                                <i class="fa fa-rss fa-lg fa-fw mr-1"></i>
                            
                            <a href="feed.xml">RSS</a>
                        </li>
                    
                        <li>
                            
                                <i class="fab fa-github fa-lg fa-fw mr-1"></i>
                            
                            <a href="https://github.com/vmware-tanzu/velero">GitHub</a>
                        </li>
                    
                </ul>
            </div>
            <div class="col-12 col-md-4 text-center text-md-right">
                <a href="/" aria-label="Velero homepage"><img src="/img/Velero.svg" class="logo"
                                                              alt="Homepage"/></a>
            </div>
        </div>
        <div class="row align-items-center">
            <div class="col copyright text-center text-md-right mt-4">
                &copy; 2020 Velero Authors.
                <a href="http://vmware.github.io/" class="vm-logo">A VMware-backed project. <img
                            src="/img/vm-logo.png" alt="VMware logo"/></a>
            </div>
        </div>
    </div>
</footer>


<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js"
        integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>

<script src="/js/jquery.matchHeight.js?1593121911"></script>
<script src="/js/scripts.js?1593121911"></script>

    </div>
</div>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
        apiKey: '3d80f66bb5ecf85f8e2760caef383f24',
        indexName: 'velero',
        inputSelector: '.docsearch-input',
        algoliaOptions: {'facetFilters': ["version:v1.3.1"]},
        debug: false 
    });
</script>
</body>

</html>
