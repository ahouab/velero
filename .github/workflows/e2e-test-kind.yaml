name: "Run the E2E test on kind"
on:
  push:
  pull_request:
    # Do not run when the change only includes these directories.
    paths-ignore:
      - "site/**"
      - "design/**"

jobs:
  # Build the Velero CLI and image once for all Kubernetes versions, and cache it so the fan-out workers can get it.
  build:
    runs-on: ubuntu-latest
    steps:
      # Look for a CLI that's made for this PR
      - name: Fetch built CLI
        id: cache
        uses: actions/cache@v2
        env:
          cache-name: cache-velero-cli
        with:
          path: ./_output/bin/linux/amd64/velero
          # The cache key a combination of the current PR number and the commit SHA
          key: velero-${{ github.event.pull_request.number }}-${{ github.sha }}

      # TODO image

      - name: Fetch cached go modules
        uses: actions/cache@v2
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Check out the code
        uses: actions/checkout@v2
        if: steps.cache.outputs.cache-hit != 'true'

      # If no binaries were built for this PR, build it now.
      - name: Build Velero CLI
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          make local

  # Run E2E test against all kubernetes versions on kind
  run-e2e-test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        k8s:
          #- 1.15.12
          #- 1.16.15
          #- 1.17.17
          #- 1.18.15
          #- 1.19.7
          - 1.20.2
    steps:
      - name: Check out the code
        uses: actions/checkout@v2
      - name: Install MinIO
        run: |
          docker run -d --rm -p 9000:9000 -e "MINIO_ACCESS_KEY=minio" -e "MINIO_SECRET_KEY=minio123" -e "MINIO_DEFAULT_BUCKETS=bucket,additional-bucket" bitnami/minio
      - uses: engineerd/setup-kind@v0.5.0
        with:
          image: "kindest/node:v${{ matrix.k8s }}"
      - name: Fetch built CLI
        id: cache
        uses: actions/cache@v2
        env:
          cache-name: cache-velero-cli
        with:
          path: ./_output/bin/linux/amd64/velero
          key: velero-${{ github.event.pull_request.number }}-${{ github.sha }}
      # always try to fetch the cached go modules as the e2e test needs it either
      - name: Fetch cached go modules
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Run E2E test
        # TODO credential file
        # TODO specify cli path
        # TODO load image
        run: |
          cat << EOF > /tmp/credential
          [default]
          aws_access_key_id=minio
          aws_secret_access_key=minio123
          EOF
          GOPATH=~/go CLOUD_PROVIDER=kind \
              OBJECT_STORE_PROVIDER=aws BSL_CONFIG=region=minio,s3ForcePathStyle="true",s3Url=http://$(hostname -i):9000 \
              CREDS_FILE=/tmp/credential BSL_BUCKET=bucket \
              ADDITIONAL_OBJECT_STORE_PROVIDER=aws ADDITIONAL_BSL_CONFIG=region=minio,s3ForcePathStyle="true",s3Url=http://$(hostname -i):9000 \
              ADDITIONAL_CREDS_FILE=/tmp/credential ADDITIONAL_BSL_BUCKET=additional-bucket \
              VELERO_IMAGE=velero/velero:main \
              make -C test/e2e run
